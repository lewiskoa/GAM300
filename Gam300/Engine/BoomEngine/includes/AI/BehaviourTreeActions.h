#pragma once

#include "BehaviourTree.h"
#include "Actions.h"
#include "ECS/ECS.hpp"

namespace Boom {

    // ?????????????????????????????????????????????????????????????-
    // Patrol + Seek (Auto mode)
    // ??????????????????????????????????????????????????????????????
    BOOM_INLINE std::unique_ptr<BTNode> BuildPatrolSeekTree()
    {
        using U = std::unique_ptr<BTNode>;
        // Root: Try chase branch; if it fails, do patrol branch
        return std::make_unique<Selector>(std::vector<U>{
            // If we can see player, keep chasing while we haven't lost them
            std::make_unique<Sequence>(std::vector<U>{
                std::make_unique<SeePlayerCond>(),
                    std::make_unique<SeekPlayerAction>(),
                    std::make_unique<StillChasingCond>() // keeps sequence running while valid
            }),
                // Patrol branch: go next waypoint, then idle a bit
                std::make_unique<Sequence>(std::vector<U>{
                std::make_unique<PatrolAction>(),
                    // Optional cooldown so it doesn't instantly switch points
                    std::make_unique<Cooldown>(std::make_unique<IdleAction>(), 0.0f)
            })
        });
    }

    // ??????????????????????????????????????????????????????????????
    // Idle-only tree (AIMode::Idle)
    // ??????????????????????????????????????????????????????????????
    BOOM_INLINE std::unique_ptr<BTNode> BuildIdleTree()
    {
        using U = std::unique_ptr<BTNode>;
        // Just keep idling forever
        return std::make_unique<Sequence>(std::vector<U>{
            std::make_unique<IdleAction>()
        });
    }

    // ??????????????????????????????????????????????????????????????
    // Patrol-only tree (AIMode::Patrol)
    // ??????????????????????????????????????????????????????????????
    BOOM_INLINE std::unique_ptr<BTNode> BuildPatrolOnlyTree()
    {
        using U = std::unique_ptr<BTNode>;
        // Move along patrol points, with a small idle at each
        return std::make_unique<Sequence>(std::vector<U>{
            std::make_unique<PatrolAction>(),
                std::make_unique<Cooldown>(std::make_unique<IdleAction>(), 0.0f)
        });
    }

    // ??????????????????????????????????????????????????????????????
    // Seek-only tree (AIMode::Seek)
    // ??????????????????????????????????????????????????????????????
    BOOM_INLINE std::unique_ptr<BTNode> BuildSeekOnlyTree()
    {
        using U = std::unique_ptr<BTNode>;
        // Only care about chasing the player
        return std::make_unique<Sequence>(std::vector<U>{
            std::make_unique<SeePlayerCond>(),
                std::make_unique<SeekPlayerAction>(),
                std::make_unique<StillChasingCond>()
        });
    }

    // ??????????????????????????????????????????????????????????????
    // Main factory used by AISystem
    // ??????????????????????????????????????????????????????????????
    BOOM_INLINE std::unique_ptr<BTNode> BuildTreeForMode(AIComponent::AIMode mode)
    {
        switch (mode)
        {
        case AIComponent::AIMode::Idle:
            return BuildIdleTree();

        case AIComponent::AIMode::Patrol:
            return BuildPatrolOnlyTree();

        case AIComponent::AIMode::Seek:
            return BuildSeekOnlyTree();

        case AIComponent::AIMode::Auto:
        default:
            return BuildPatrolSeekTree();
        }
    }

} // namespace Boom
